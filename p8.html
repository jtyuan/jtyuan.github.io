<!DOCTYPE html>
<meta charset="utf-8">
<title>Project 8:  Web Browsing By Voice</title>
<style>
  body {
    padding-left: 256px;
    padding-right: 256px;
  }
  select {
    display: none;
  }
  * {
    font-family: Verdana, Arial, sans-serif;
  }
  a:visited {
    color:#000;
  }
  a:hover {
    color:red;
  }
  .button {
    background: -webkit-linear-gradient(top,#008dfd 0,#0370ea 100%);
    border: 1px solid #076bd2;
    border-radius: 3px;
    color: #fff;
    font-size: 13px;
    font-weight: bold;
    line-height: 1.3;
    padding: 8px 25px;
    text-align: center;
    text-shadow: 1px 1px 1px #076bd2;
    letter-spacing: normal;
  }
  .center {
    padding: 10px;
    text-align: center;
  }
  .final {
    color: black;
    padding-right: 3px; 
  }
  .interim {
    color: gray;
  }
  .info {
    font-size: 14px;
    text-align: center;
    color: #777;
    display: none;
  }
  .right {
    float: right;
  }
  .sidebyside {
    display: inline-block;
    width: 45%;
    min-height: 40px;
    text-align: left;
    vertical-align: top;
  }
  #headline {
    font-size: 40px;
    font-weight: 300;
  }
  #info {
    font-size: 20px;
    text-align: center;
    color: #777;
    visibility: hidden;
  }
  #results {
    font-size: 14px;
    font-weight: bold;
    border: 1px solid #ddd;
    padding: 15px;
    text-align: left;
    min-height: 14px;
  }
  #start_button {
    border: 0;
    background-color:transparent;
    padding: 0;
  }
</style>
<h1 class="center" id="headline">Project 8:  Web Browsing By Voice</h1>
<div id="info">
  <p id="info_start">Click on the microphone icon and begin speaking.</p>
  <p id="info_speak_now">Speak now.</p>
  <p id="info_no_speech">No speech was detected. You may need to adjust your
    <a href="//support.google.com/chrome/bin/answer.py?hl=en&amp;answer=1407892">
      microphone settings</a>.</p>
  <p id="info_no_microphone" style="display:none">
    No microphone was found. Ensure that a microphone is installed and that
    <a href="//support.google.com/chrome/bin/answer.py?hl=en&amp;answer=1407892">
    microphone settings</a> are configured correctly.</p>
  <p id="info_allow">Click the "Allow" button above to enable your microphone.</p>
  <p id="info_denied">Permission to use microphone was denied.</p>
  <p id="info_blocked">Permission to use microphone is blocked. To change,
    go to chrome://settings/contentExceptions#media-stream</p>
  <p id="info_upgrade">Web Speech API is not supported by this browser.
     Upgrade to <a href="//www.google.com/chrome">Chrome</a>
     version 25 or later.</p>
</div>
<div class="right">
  <button id="start_button" onclick="startButton(event)">
    <img id="start_img" src="img/mic.gif" alt="Start"></button>
</div>
<div id="results">
  <span id="final_span" class="final"></span>
  <span id="interim_span" class="interim"></span>
  <p>
</div>
<div class="center">
  <div class="sidebyside" style="text-align:right">
    <button class="button" onclick="clickButton(event)">
      first</button>
  </div>
  <div class="sidebyside">
    <button class="button" onclick="clickButton(event)">
      second</button>
  </div>
  <p>
  <div class="sidebyside" style="text-align:right">
    <a href="https://google.com" onclick="clickLink(event)">
      google</a>
  </div>
  <div class="sidebyside">
    <a href="https://cmu.edu" onclick="clickLink(event)">
      CMU</a>
  </div>
  <p>
  <input type='text' placeholder="first">
  <input type='text' placeholder="second">
  <p>
  <div id="div_language">
    <select id="select_language" onchange="updateCountry()"></select>
    &nbsp;&nbsp;
    <select id="select_dialect"></select>
  </div>
</div>
  <div>

  <p>
    Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam quis metus velit. Sed urna mi, mollis non semper eget, congue at ante. In hac habitasse platea dictumst. Praesent malesuada tempor justo, et vehicula eros mollis ac. In congue fringilla eros, vel tincidunt diam gravida eleifend. Phasellus gravida nec lacus eu sagittis. Nam sed pulvinar leo. Donec eget neque ipsum. Aenean sed aliquam urna. Suspendisse sit amet nisi ex.
<p>
Phasellus laoreet urna justo, at dignissim leo blandit vitae. Aliquam eget tincidunt sem. Sed finibus lorem et diam accumsan sollicitudin. Donec lobortis fringilla dignissim. Nam finibus scelerisque auctor. Vestibulum ut consectetur justo. Duis velit nisl, lacinia et viverra ut, posuere vitae nibh.
<p>
Integer a diam at nisl aliquet fringilla. Vestibulum id malesuada turpis. Aliquam erat volutpat. Aenean lorem purus, facilisis a leo et, aliquet ornare magna. Praesent a commodo turpis. Maecenas imperdiet ornare enim, sit amet faucibus sapien ullamcorper vitae. Phasellus consequat eget augue nec venenatis. Fusce dictum ut justo ut accumsan. Nam non augue pellentesque, auctor lorem non, scelerisque sapien. Aenean et pretium sem. In justo erat, consequat vitae nisl non, varius semper augue. Sed placerat et ipsum vitae egestas. Sed hendrerit mi at lacus faucibus, eu molestie neque lobortis.
<p>
Etiam varius dolor at congue ullamcorper. Pellentesque pretium, odio tincidunt commodo tempus, metus enim posuere dui, nec tristique justo ante vel risus. Aenean magna nisi, sodales eget convallis quis, condimentum sed mauris. Donec finibus turpis eget turpis finibus varius. Aliquam ut ex sem. Suspendisse ultricies eros in odio dapibus, eu sagittis ex pulvinar. Sed nec sem quis sapien sagittis aliquam at id augue. Sed eget lobortis erat. Ut quis erat id mi euismod pellentesque. Vivamus in massa et enim dapibus fringilla. In semper lorem ante, hendrerit vestibulum tortor porttitor a.
<p>
Integer tempus placerat lacus sed euismod. Praesent vel nunc commodo eros tristique gravida. Morbi consectetur eros quam, ut dictum enim hendrerit at. Nunc tristique dignissim turpis non scelerisque. Vestibulum viverra, felis ut malesuada vehicula, erat mi rutrum turpis, non tincidunt leo tortor at metus. Donec laoreet mauris in leo molestie, id pellentesque arcu cursus. Vivamus ac tempor leo. Nullam rutrum, odio a accumsan suscipit, purus nunc sagittis nisi, eu facilisis lacus ipsum ut turpis. Sed augue ipsum, scelerisque et nisi id, feugiat pretium dolor. Etiam facilisis est eget nisi sollicitudin, in venenatis neque dapibus. Donec vitae risus ac ante faucibus consectetur ac dapibus odio. Aenean tempor arcu sit amet ullamcorper tincidunt. Interdum et malesuada fames ac ante ipsum primis in faucibus. Pellentesque ultrices ligula et lacinia dapibus.
  </p>
</div>
<script type="text/javascript" src="js/jquery.min.js"></script>
<script>
var langs =
[['Afrikaans',       ['af-ZA']],
 ['Bahasa Indonesia',['id-ID']],
 ['Bahasa Melayu',   ['ms-MY']],
 ['Català',          ['ca-ES']],
 ['Čeština',         ['cs-CZ']],
 ['Deutsch',         ['de-DE']],
 ['English',         ['en-AU', 'Australia'],
                     ['en-CA', 'Canada'],
                     ['en-IN', 'India'],
                     ['en-NZ', 'New Zealand'],
                     ['en-ZA', 'South Africa'],
                     ['en-GB', 'United Kingdom'],
                     ['en-US', 'United States']],
 ['Español',         ['es-AR', 'Argentina'],
                     ['es-BO', 'Bolivia'],
                     ['es-CL', 'Chile'],
                     ['es-CO', 'Colombia'],
                     ['es-CR', 'Costa Rica'],
                     ['es-EC', 'Ecuador'],
                     ['es-SV', 'El Salvador'],
                     ['es-ES', 'España'],
                     ['es-US', 'Estados Unidos'],
                     ['es-GT', 'Guatemala'],
                     ['es-HN', 'Honduras'],
                     ['es-MX', 'México'],
                     ['es-NI', 'Nicaragua'],
                     ['es-PA', 'Panamá'],
                     ['es-PY', 'Paraguay'],
                     ['es-PE', 'Perú'],
                     ['es-PR', 'Puerto Rico'],
                     ['es-DO', 'República Dominicana'],
                     ['es-UY', 'Uruguay'],
                     ['es-VE', 'Venezuela']],
 ['Euskara',         ['eu-ES']],
 ['Français',        ['fr-FR']],
 ['Galego',          ['gl-ES']],
 ['Hrvatski',        ['hr_HR']],
 ['IsiZulu',         ['zu-ZA']],
 ['Íslenska',        ['is-IS']],
 ['Italiano',        ['it-IT', 'Italia'],
                     ['it-CH', 'Svizzera']],
 ['Magyar',          ['hu-HU']],
 ['Nederlands',      ['nl-NL']],
 ['Norsk bokmål',    ['nb-NO']],
 ['Polski',          ['pl-PL']],
 ['Português',       ['pt-BR', 'Brasil'],
                     ['pt-PT', 'Portugal']],
 ['Română',          ['ro-RO']],
 ['Slovenčina',      ['sk-SK']],
 ['Suomi',           ['fi-FI']],
 ['Svenska',         ['sv-SE']],
 ['Türkçe',          ['tr-TR']],
 ['български',       ['bg-BG']],
 ['Pусский',         ['ru-RU']],
 ['Српски',          ['sr-RS']],
 ['한국어',            ['ko-KR']],
 ['中文',             ['cmn-Hans-CN', '普通话 (中国大陆)'],
                     ['cmn-Hans-HK', '普通话 (香港)'],
                     ['cmn-Hant-TW', '中文 (台灣)'],
                     ['yue-Hant-HK', '粵語 (香港)']],
 ['日本語',           ['ja-JP']],
 ['Lingua latīna',   ['la']]];

for (var i = 0; i < langs.length; i++) {
  select_language.options[i] = new Option(langs[i][0], i);
}
select_language.selectedIndex = 6;
updateCountry();
select_dialect.selectedIndex = 6;
showInfo('info_start');

function updateCountry() {
  for (var i = select_dialect.options.length - 1; i >= 0; i--) {
    select_dialect.remove(i);
  }
  var list = langs[select_language.selectedIndex];
  for (var i = 1; i < list.length; i++) {
    select_dialect.options.add(new Option(list[i][1], list[i][0]));
  }
  select_dialect.style.visibility = list[1].length == 1 ? 'hidden' : 'visible';
}

var create_email = false;
var final_transcript = '';
var recognizing = false;
var ignore_onend;
var start_timestamp;
var focused_input = null;
if (!('webkitSpeechRecognition' in window)) {
  upgrade();
} else {
  start_button.style.display = 'inline-block';
  var recognition = new webkitSpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onstart = function() {
    recognizing = true;
    showInfo('info_speak_now');
    start_img.src = 'img/mic-animate.gif';
  };

  recognition.onerror = function(event) {
    if (event.error == 'no-speech') {
      start_img.src = 'img/mic.gif';
      showInfo('info_no_speech');
      ignore_onend = true;
    }
    if (event.error == 'audio-capture') {
      start_img.src = 'img/mic.gif';
      showInfo('info_no_microphone');
      ignore_onend = true;
    }
    if (event.error == 'not-allowed') {
      if (event.timeStamp - start_timestamp < 100) {
        showInfo('info_blocked');
      } else {
        showInfo('info_denied');
      }
      ignore_onend = true;
    }
  };

  recognition.onend = function() {
    recognizing = false;
    if (ignore_onend) {
      return;
    }
    start_img.src = 'img/mic.gif';
    if (!final_transcript) {
      showInfo('info_start');
      return;
    }
    showInfo('');
    if (window.getSelection) {
      window.getSelection().removeAllRanges();
      var range = document.createRange();
      range.selectNode(document.getElementById('final_span'));
      window.getSelection().addRange(range);
    }
  };

  recognition.onresult = function(event) {
    var interim_transcript = '';
    for (var i = event.resultIndex; i < event.results.length; ++i) {
      if (event.results[i].isFinal) {
        final_transcript += event.results[i][0].transcript;
      } else {
        interim_transcript += event.results[i][0].transcript;
      }
    }
    final_transcript = final_transcript.toLowerCase();
    final_span.innerHTML = linebreak(final_transcript);
    interim_span.innerHTML = linebreak(interim_transcript);
    
    if (final_transcript) {
      execute(final_transcript.trim())
      final_transcript = ''
      return;
    }
  };
}

function upgrade() {
  start_button.style.visibility = 'hidden';
  showInfo('info_upgrade');
}

var two_line = /\n\n/g;
var one_line = /\n/g;
function linebreak(s) {
  return s.replace(two_line, '<p></p>').replace(one_line, '<br>');
}

function clickButton(event) {
  if (recognizing) {
    recognizing = false;
    recognition.stop();
  }
  let text = $(event.target).text().trim()
  alert('Button "' + text + '" clicked.')
}

function clickLink(event) {
  if (recognizing) {
    recognizing = false;
    recognition.stop();
  }
  let text = $(event.target).text().trim()
  alert('Link "' + text + '" clicked.')
}

function startButton(event) {
  if (recognizing) {
    recognition.stop();
    return;
  }
  final_transcript = '';
  recognition.lang = select_dialect.value;
  recognition.start();
  ignore_onend = false;
  final_span.innerHTML = '';
  interim_span.innerHTML = '';
  start_img.src = 'img/mic-slash.gif';
  showInfo('info_allow');
  start_timestamp = event.timeStamp;
}

function showInfo(s) {
  if (s) {
    for (var child = info.firstChild; child; child = child.nextSibling) {
      if (child.style) {
        child.style.display = child.id == s ? 'inline' : 'none';
      }
    }
    info.style.visibility = 'visible';
  } else {
    info.style.visibility = 'hidden';
  }
}

function execute(cmd) {
  let parts = cmd.split(/\s/)
  switch (parts[0]) {
  case 'click':
    var clicked = false
    if (parts.indexOf('button') > -1) {
      $('button').each(function() {
        let text = $(this).text().trim().toLowerCase()
        if (text && !clicked && cmd.indexOf(text) > -1) {
          clicked = this
        }
      });
    } else if (parts.indexOf('link') > -1) {
      $('a').each(function() {
        let text = $(this).text().trim().toLowerCase()
        if (text && !clicked && cmd.indexOf(text) > -1) {
          clicked = this
        }
      });
    } else if (parts.indexOf('input') > -1 || parts.indexOf('text') > -1) {
      $('input').each(function() {
        let text = $(this).attr('placeholder').trim().toLowerCase()
        if (text && !clicked && cmd.indexOf(text) > -1) {
          focused_input = this
          clicked = this
        }
      });
    } else {
      $('input,button,a').each(function() {
        var text = ''
        if ($(this)[0].tagName == "INPUT") {
          text = $(this).attr('placeholder').trim().toLowerCase()
        } else {
          text = $(this).text().trim().toLowerCase()
        }
        if (text && !clicked && cmd.indexOf(text) > -1) {
          if ($(this)[0].tagName == "INPUT") {
            focused_input = this
          }
          clicked = this
        }
      });
    }
    console.log(clicked)
    if (!clicked) {
      speechSynthesis.cancel();
      speechSynthesis.speak(new SpeechSynthesisUtterance('Sorry, I cannot find the element you want to click'));
    } else {
      simulateClick(clicked)
    }

    break
  case 'enter':
    if (focused_input === null) {
      speechSynthesis.cancel();
      speechSynthesis.speak(new SpeechSynthesisUtterance('Sorry, you haven\'t told me which input text field to enter'));
    } else {
      $(focused_input).val(parts.slice(parts.indexOf('enter') + 1).join(' '))
    }

    break
  case 'scroll':
    if (parts.indexOf('up') > -1) {
      scrollUp()
    } else if (parts.indexOf('down') > -1) {
      scrollDown()
    } else {
      speechSynthesis.cancel();
      speechSynthesis.speak(new SpeechSynthesisUtterance('Sorry, please tell me whether to scroll up or scroll down'));
    }
    break
  default:
    speechSynthesis.cancel();
    speechSynthesis.speak(new SpeechSynthesisUtterance('Sorry, I don\'t understand ' + cmd));
  }
}

function simulateClick (element) {
  if (!element) return
  let dispatchEvent = function (elt, name) {
    let clickEvent = document.createEvent('MouseEvents')
    clickEvent.initEvent(name, true, true)
    elt.dispatchEvent(clickEvent)
  }
  dispatchEvent(element, 'mouseover')
  dispatchEvent(element, 'mousedown')
  dispatchEvent(element, 'click')
  dispatchEvent(element, 'mouseup')
}

function scrollUp() {
  $('html, body').animate({
      scrollTop: $(document).scrollTop() - 150
    }, 1000)
}

function scrollDown() {
  $('html, body').animate({
      scrollTop: $(document).scrollTop() + 150
    }, 1000)
}
</script>